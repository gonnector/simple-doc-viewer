# Simple Doc Viewer — 개발 일지

**프로젝트 시작**: 2026-02-22

---

## Phase 0: 설계 (2026-02-22)

### 사용 스킬
- `brainstorming` — 프로젝트 설계 및 접근법 비교
- `writing-plans` — 상세 구현 계획 수립

### 결정 사항

1. **접근법 선택: 점진적 강화 (Progressive Enhancement)**
   - 대안 A (일괄 구축): 2000줄 이상의 단일 파일을 한 번에 작성 시 디버깅 리스크가 높아 탈락
   - 대안 B (컴포넌트 분리 후 조립): PRD의 "단일 파일" 요구사항과 상충하여 탈락
   - 선택한 방식: 5단계로 나누어 매 단계마다 브라우저에서 동작 확인

2. **reference 코드 활용 전략**
   - markdown-viewer.html의 마크다운 파서를 Phase 3에서 통합
   - doc-explorer.html의 파일 트리/탭 시스템을 Phase 2, 4에서 참고
   - 정적 프로토타입에서 검증된 코드를 서버 연동 코드로 변환

3. **문서화 수준: 전체 개발 일지**
   - 설계 문서: docs/plans/에 설계 결정사항과 구현 계획
   - 개발 일지: docs/dev-journal.md에 Phase별 결정/대안/교훈 기록

### 교훈
- PRD와 reference 프로토타입이 잘 준비되어 있으면 설계 단계에서 불확실성이 크게 줄어든다
- 단일 파일 프로젝트라도 내부 논리적 구조를 명확히 정의하면 유지보수성이 향상된다

---

## Phase 1-5: 통합 구현 (2026-02-22)

### 접근법 변경 결정

**원래 계획**: 5 Phase를 순차적으로 나눠 구현
**실제 실행**: 전체 context를 확보한 상태에서 5 Phase를 한 번에 통합 구현

**변경 이유**:
- reference 프로토타입의 코드를 완전히 분석 완료한 상태에서, 단계별로 나누면 HTML 구조를 매번 재구성해야 하는 비효율 발생
- 서버 측 코드(~240줄)와 프론트엔드 코드(~1800줄)의 의존 관계가 강해 분리 구현이 비효율적
- 전체 설계가 명확했으므로 통합 구현 후 브라우저 테스트가 더 효율적

### 사용 스킬
- `writing-plans` — 구현 계획에 실제 코드 포함
- 수동 API 테스트 — curl로 엔드포인트 검증

### 핵심 기술적 결정

1. **Template literal 안의 클라이언트 JS**
   - 문제: getHTML() 함수가 template literal로 HTML을 반환하므로, 내부 JS에서 backtick과 ${} 사용 불가
   - 대안 A: function.toString()으로 함수 본문 추출 → 취약하고 비표준적
   - 대안 B: 별도 .html 파일로 분리 → PRD의 "단일 파일" 요구사항 위반
   - **선택**: 클라이언트 JS에서 single quote + 문자열 연결만 사용 → 가장 안정적

2. **이벤트 위임 (Event Delegation)**
   - 대안: 개별 요소에 onclick 인라인 핸들러 → 파일 경로에 특수 문자 있으면 깨짐
   - **선택**: 부모 요소에 단일 리스너 + data-* 속성 → 깔끔하고 안전

3. **중첩 리스트 파서**
   - reference의 깊이 추적 방식: 다음 줄 peek로 열기/닫기 판단 → 버그 발생 가능
   - **선택**: 스택 기반 알고리즘 → indent 레벨을 스택으로 관리하여 임의 깊이 지원

4. **Mermaid 다운로드**
   - HTTPS redirect 처리 필요 (CDN이 302 응답)
   - 재귀적 redirect following (최대 5회) 구현
   - 실패 시 서버는 정상 시작, 다이어그램만 비활성화 (graceful degradation)

5. **보안 구현**
   - 경로 순회: path.resolve() 후 ROOT_DIR 접두사 확인
   - 바이너리 파일: 확장자 화이트리스트 기반 판별
   - 대용량: fs.statSync로 1MB 초과 시 즉시 거부
   - 외부 접근: 127.0.0.1 바인딩

### API 테스트 결과

| 테스트 | 결과 |
|--------|------|
| /api/list (루트) | 정상 — 폴더 먼저, 이름순 정렬, hidden 플래그 포함 |
| /api/read (PRD.md) | 정상 — path, name, ext, size, content 반환 |
| /api/list (하위 폴더) | 정상 — reference/ 폴더 내용 반환 |
| 경로 순회 (C:/Windows/...) | 차단 — "Access denied" 반환 |
| / (HTML) | 정상 — 완전한 HTML 서빙 |
| Mermaid 다운로드 | 정상 — CDN에서 자동 다운로드 완료 |

### 최종 파일 구조

```
server.js (~2000줄)
├─ [1] 모듈 & 설정        (1-52)    — 포트, 루트, 확장자 목록
├─ [2] 유틸리티 함수       (54-75)   — 텍스트 판별, 경로 검증, JSON 응답
├─ [3] Mermaid 다운로더    (77-110)  — HTTPS redirect following
├─ [4] API 핸들러          (112-178) — /api/list, /api/read
├─ [5] HTML 프론트엔드     (180-~)   — getHTML() 함수
│   ├─ CSS                           — 다크 테마, 30+ CSS 변수
│   ├─ Body HTML                     — 헤더, 사이드바, 콘텐츠
│   └─ Client JS                     — 상태관리, API, 트리, 탭, MD파서, 구문강조
└─ [6] 서버 시작           (마지막)  — createServer, 라우팅, listen
```

### 교훈

1. **단일 파일 아키텍처의 제약**: template literal 내 JS 코드에서 template literal을 쓸 수 없다는 제약이 코드 품질에 영향. 프로젝트 규모가 커지면 별도 파일 분리가 필요
2. **reference 프로토타입의 가치**: 두 프로토타입에서 마크다운 파서, 구문 강조, UI 패턴을 모두 재사용하여 개발 속도 대폭 향상
3. **설계 단계 투자 수익**: brainstorming + writing-plans에 시간을 투자한 덕분에 구현 시 거의 고민 없이 코드 작성 가능

---

## 브라우저 테스트 & 버그 수정 (2026-02-22)

### 브라우저 테스트 결과

| 기능 | 결과 | 비고 |
|------|------|------|
| 기본 레이아웃 | 정상 | 사이드바, 파일 트리, 환영 화면 |
| 파일 트리 탐색 | 정상 | 폴더 진입, 상위 이동, 경로 배지 업데이트 |
| 마크다운 렌더링 (h1-h6) | 정상 | 크기별 색상 구분 |
| 인라인 서식 | 정상 | 굵게, 기울임, 취소선, 인라인 코드 |
| 중첩 목록 (3단계) | 정상 | 스택 기반 파서로 정확한 들여쓰기 |
| 순서 목록 + 하위 항목 | 정상 | ol/ul 혼합 중첩 |
| 체크리스트 | 정상 | 체크박스 렌더링 |
| 인용문 (중첩) | 정상 | 단계별 다른 border 색상 |
| 코드 블록 (Python, Bash, JS) | 정상 | 언어 배지 + 구문 강조 |
| 테이블 (정렬 포함) | 정상 | 왼쪽/가운데/오른쪽 정렬, 이모지 포함 |
| 각주 | 정상 | 참조 링크 + 돌아가기 화살표 |
| 이모지 & 특수문자 | 정상 | 모든 문자 정상 표시 |
| details/summary | 정상 | 클릭으로 접기/펼치기 작동 |
| 하이라이트 (mark) | 정상 | 노란색 배경 |
| kbd 태그 | 정상 | 키보드 스타일 박스 |
| 수평선 (3가지 방식) | 정상 | 별표/하이픈/밑줄 모두 렌더링 |
| 탭 시스템 | 정상 | 열기, 전환, 닫기 (×) |
| 탭 닫기 후 전환 | 정상 | 활성 탭 닫으면 인접 탭으로 자동 전환 |
| JS 구문 강조 | 정상 | 키워드(빨강), 문자열(파랑), 숫자(시안), 주석(회색) |
| 검색/필터 | 정상 | 파일명 부분 매칭으로 즉시 필터링 |
| Hidden 토글 | 정상 | .claude 등 숨김 폴더 표시/숨김 전환 |
| Mermaid 라이브러리 로드 | 정상 | mermaid 전역 객체 확인됨 |
| 보안 (ROOT_DIR 밖 접근) | 정상 | "Access denied" 반환 |

### 발견된 버그 & 수정

**버그: 루트 디렉토리에서 ".." 클릭 시 "Access denied" 오류**
- **증상**: 루트 디렉토리(`ROOT_DIR`)에서 ".." 항목 클릭 시 부모 디렉토리가 `ROOT_DIR` 밖이므로 API가 "Access denied"를 반환하고, 파일 트리 영역에 오류 텍스트가 표시되어 복구 불가
- **원인**: 서버의 `/api/list` 응답에서 `parent` 필드에 `ROOT_DIR` 밖 경로를 반환
- **수정**: `isPathSafe()` 검증을 `parent` 계산에 추가 — `ROOT_DIR` 밖이면 `parent: null` 반환
- **수정 코드**: `server.js:175-176` — `parentSafe` 변수로 안전한 경로만 반환

### 교훈

1. **서버-클라이언트 신뢰 경계**: 서버가 반환하는 모든 경로가 유효한지 서버 측에서 검증해야 한다. 클라이언트가 서버 응답을 그대로 신뢰하고 API를 호출하면 에러가 발생할 수 있다
2. **브라우저 테스트의 가치**: curl API 테스트로는 잡지 못한 UX 버그를 브라우저 테스트에서 발견

---

## v0.5: 3대 기능 추가 (2026-02-22)

### 추가 기능

1. **Day/Night 모드 (Theme 토글)**
   - `body.light-mode` CSS 클래스로 `:root` 변수 오버라이드
   - 밝은 배경(#ffffff), 어두운 텍스트(#1f2328), 파란 링크(#0969da)
   - 구문 강조 토큰, 마크다운 요소(code, blockquote, thead 등) 전부 오버라이드
   - Mermaid 테마도 연동: dark ↔ default 자동 전환

2. **마크다운 Split View (Source 토글)**
   - Flexbox 50/50 2패널 레이아웃
   - 왼쪽: 라인 넘버 포함 원본 소스, 오른쪽: 렌더링된 마크다운
   - 비례 스크롤 동기화 (ratio = scrollTop / maxScroll)
   - `syncing` 플래그로 무한 스크롤 루프 방지

3. **Mermaid 9종 다이어그램 테스트 문서**
   - `reference/mermaid-test.md` 신규 생성
   - Flowchart, Sequence, Class, State, ER, Gantt, Pie, Mindmap, Git Graph

### 핵심 기술적 결정

1. **Mermaid 테마 전환 방식**
   - 문제: 이미 렌더링된 Mermaid SVG에는 색상이 인라인으로 적용됨
   - 대안: SVG 내부 스타일을 CSS로 오버라이드 → SVG 구조가 다이어그램 타입마다 달라 불가능
   - **선택**: `renderContent()` 전체 재실행 → `<pre>` 태그부터 재생성 후 `renderMermaidBlocks()` 재호출

2. **Split View 스크롤 동기화**
   - 대안 A: 같은 scrollTop 값 동기화 → 패널 높이가 다르면 어긋남
   - **선택**: 비율 기반 (scrollTop / (scrollHeight - clientHeight)) → 컨텐츠 길이 차이에도 자연스러운 동기화

### v0.5 브라우저 테스트 결과

| 기능 | 결과 | 비고 |
|------|------|------|
| Theme 토글 (다크→라이트) | 정상 | 배경, 텍스트, 사이드바 전환 |
| Theme 토글 (라이트→다크) | 정상 | 원래 상태로 복귀 |
| Source 토글 (Split View 열기) | 정상 | 좌우 50/50 분할 |
| Source 토글 (Split View 닫기) | 정상 | 렌더링만 전체 화면 복귀 |
| 스크롤 동기화 | 정상 | 비례 스크롤 정확 |
| Mermaid 9종 (다크 모드) | 정상 | 전 종류 렌더링 확인 |
| Mermaid 9종 (라이트 모드) | 정상 | 테마 전환 후 색상 변경 확인 |
| Split View + Mermaid + Light Mode 조합 | 정상 | 3기능 동시 동작 |

### LaTeX 지원 평가

- **추천 라이브러리**: KaTeX (JS 140KB + CSS 8KB + auto-render 5KB)
- **v0.6 연기 사유**: Mermaid는 단일 JS 파일이지만 KaTeX는 폰트 파일 필요, 마크다운 파서에서 `$...$` / `$$...$$` 이스케이프 처리 수정 필요, 별도 CSS 서빙 라우트 추가 필요

### 교훈

1. **CSS 변수 패턴의 위력**: `:root` 변수 + `body.light-mode` 오버라이드만으로 600줄+ UI의 테마를 깔끔하게 전환
2. **재렌더링 vs 스타일 오버라이드**: Mermaid처럼 인라인 SVG를 생성하는 라이브러리는 CSS 오버라이드가 아닌 전체 재렌더링이 필요
3. **스크롤 동기화의 무한 루프**: 양쪽 패널에 scroll 이벤트가 있으면 한쪽 스크롤 → 다른 쪽 스크롤 → 다시 첫 번째 스크롤 → 무한 루프. `syncing` 플래그로 방지
