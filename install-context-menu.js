// ============================================================
// SDV Context Menu Installer — install-context-menu.js
// Windows 우클릭 컨텍스트 메뉴 "SDV로 읽기" 등록/해제
// Node.js 내장 모듈만 사용, npm 의존성 없음
// ============================================================

var fs = require('fs');
var path = require('path');
var child_process = require('child_process');

// === 경로 설정 ===
var VBS_PATH = path.join(__dirname, 'sdv-open.vbs');
var LAUNCHER_PATH = path.join(__dirname, 'launcher.js');
var NODE_EXE = process.execPath;
var REG_KEY = 'HKCU\\Software\\Classes\\*\\shell\\SDV';

// === 유틸리티 ===

function toWinPath(p) {
  return p.replace(/\//g, '\\');
}

function regExec(cmd) {
  try {
    child_process.execSync(cmd, { stdio: 'pipe' });
    return true;
  } catch (e) {
    return false;
  }
}

// === VBS 생성 ===

function generateVbs() {
  var nodePath = toWinPath(NODE_EXE);
  var launcherPath = toWinPath(LAUNCHER_PATH);

  var lines = [
    "' sdv-open.vbs — generated by install-context-menu.js",
    "If WScript.Arguments.Count = 0 Then WScript.Quit",
    'CreateObject("WScript.Shell").Run Chr(34) & "' + nodePath + '" & Chr(34) & " " & Chr(34) & "' + launcherPath + '" & Chr(34) & " " & Chr(34) & WScript.Arguments(0) & Chr(34), 0, False'
  ];

  // UTF-16 LE BOM으로 작성 (경로에 비ASCII 문자 포함 시 wscript.exe 호환)
  var bom = Buffer.from([0xFF, 0xFE]);
  var body = Buffer.from(lines.join('\r\n') + '\r\n', 'utf16le');
  fs.writeFileSync(VBS_PATH, Buffer.concat([bom, body]));
  console.log('[OK] sdv-open.vbs generated: ' + toWinPath(VBS_PATH));
}

// === 레지스트리 등록 ===

function registerContextMenu() {
  var vbsWinPath = toWinPath(VBS_PATH);

  // .reg 파일을 사용하여 한글 값을 정확하게 등록
  var regContent = 'Windows Registry Editor Version 5.00\r\n'
    + '\r\n'
    + '[HKEY_CURRENT_USER\\Software\\Classes\\*\\shell\\SDV]\r\n'
    + '@="SDV\uB85C \uC77D\uAE30"\r\n'
    + '\r\n'
    + '[HKEY_CURRENT_USER\\Software\\Classes\\*\\shell\\SDV\\command]\r\n'
    + '@="wscript.exe \\"' + vbsWinPath.replace(/\\/g, '\\\\') + '\\" \\"%1\\""\r\n';

  var regFile = path.join(__dirname, '_sdv_temp.reg');
  // .reg 파일은 UTF-16 LE BOM으로 저장해야 한글이 올바르게 적용됨
  var bom = Buffer.from([0xFF, 0xFE]);
  var body = Buffer.from(regContent, 'utf16le');
  fs.writeFileSync(regFile, Buffer.concat([bom, body]));

  try {
    child_process.execSync('reg import "' + toWinPath(regFile) + '"', { stdio: 'pipe' });
    console.log('[OK] Registry key registered: ' + REG_KEY);
  } catch (e) {
    console.error('[FAIL] Registry import failed:', e.message);
    // fallback: reg add 방식 (한글이 깨질 수 있음)
    console.log('[INFO] Trying fallback reg add...');
    regExec('reg add "' + REG_KEY + '" /ve /d "SDV" /f');
    regExec('reg add "' + REG_KEY + '\\command" /ve /d "wscript.exe \\"' + vbsWinPath + '\\" \\"%1\\"" /f');
    console.log('[OK] Registry key registered (fallback, display name may lack Korean)');
  } finally {
    // 임시 .reg 파일 삭제
    try { fs.unlinkSync(regFile); } catch (e) {}
  }
}

// === 설치 ===

function install() {
  console.log('');
  console.log('=== SDV Context Menu Installer ===');
  console.log('');

  // 1. launcher.js 존재 확인
  if (!fs.existsSync(LAUNCHER_PATH)) {
    console.error('[FAIL] launcher.js not found: ' + LAUNCHER_PATH);
    console.error('       install-context-menu.js must be in the same directory as launcher.js');
    process.exit(1);
  }

  // 2. VBS 생성
  generateVbs();

  // 3. 레지스트리 등록
  registerContextMenu();

  console.log('');
  console.log('--- Installation complete ---');
  console.log('');
  console.log('  Right-click any file in Windows Explorer');
  console.log('  and select "SDV\uB85C \uC77D\uAE30" to open it in SDV.');
  console.log('');
  console.log('  To uninstall: node install-context-menu.js --uninstall');
  console.log('');
}

// === 제거 ===

function uninstall() {
  console.log('');
  console.log('=== SDV Context Menu Uninstaller ===');
  console.log('');

  // 1. 레지스트리 키 삭제
  var deleted = regExec('reg delete "' + REG_KEY + '" /f');
  if (deleted) {
    console.log('[OK] Registry key deleted: ' + REG_KEY);
  } else {
    console.log('[SKIP] Registry key not found (already removed)');
  }

  // 2. VBS 파일 삭제
  if (fs.existsSync(VBS_PATH)) {
    fs.unlinkSync(VBS_PATH);
    console.log('[OK] sdv-open.vbs deleted: ' + toWinPath(VBS_PATH));
  } else {
    console.log('[SKIP] sdv-open.vbs not found (already removed)');
  }

  console.log('');
  console.log('--- Uninstall complete ---');
  console.log('');
}

// === 메인 ===

function main() {
  if (process.platform !== 'win32') {
    console.error('This script is for Windows only.');
    process.exit(1);
  }

  var args = process.argv.slice(2);

  if (args.indexOf('--uninstall') !== -1) {
    uninstall();
  } else {
    install();
  }
}

main();
